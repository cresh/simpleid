<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="robots" content="noindex,nofollow" />
    </head>
    <body>
        <script src="{{ @base_path }}html/alpinejs.min.js" type="text/javascript"></script>
        <script src="{{ @base_path }}html/hmac-sha256.js" type="text/javascript"></script>
        <script type="text/javascript">
            function checkSessionApp(options) {
                return {
                    cookieName: options.cookieName,

                    secure_compare: function(str1, str2) {
                        if (str1.length != str2.length) return false;

                        let result = 0;
                        for (var i = 0; i < str1.length - 1; i++) {
                            result |= str1.charCodeAt(i) ^ str2.charCodeAt(i);
                        }

                        return (result == 0);
                    }

                    checkSession($ev) {
                        const ev = $ev.originalEvent;

                        if (ev.origin != window.parent.location.origin) return;

                        const client_id = ev.data.split(' ')[0];
                        const session_state = ev.data.split(' ')[1];
                        if (typeof session_state == 'undefined') {
                            ev.source.postMessage('error', ev.origin);
                            return;
                        }

                        const salt = session_state.split('.')[1];
                        if (typeof salt == 'undefined') {
                            ev.source.postMessage('error', ev.origin);
                            return;
                        }

                        const cookies = document.cookie.split(';').map(function(cookie) {
                            return cookie.trim().split(/(=)/);
                        }).reduce(function(prev, cur) {
                            prev[cur[0]] = prev[cur[0]] ? prev[cur[0]] + ', ' + cur.slice(2).join('') : cur.slice(2).join('');
                            return prev;
                        }, {});

                        const uals = cookies[this.cookieName];

                        // This needs to match ConnectSessionModule::buildSessionState
                        const expected_session_state = CryptoJS.HmacSHA256(client_id + ' ' + ev.origin + ' ' + salt, uals) + '.' + salt;

                        let status;
                        if (secure_compare(session_state, expected_session_state)) {
                            status = 'unchanged';
                        } else {
                            status = 'changed';
                        }

                        ev.source.postMessage(status, ev.origin);
                    }
                }
            }
        </script>

        <div x-data="checkSessionApp({ cookieName: '{{ @cookie_name }}'})" @message.window="checkSession"></div>
    </body>
</html>